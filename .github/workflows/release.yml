name: Release

on:
  push:
    tags:
      - 'v*.*.*'

env:
  DOTNET_VERSION: '8.0.x'
  PROJECT_PATH: 'src/AITextVoice.Avalonia/AITextVoice.Avalonia.csproj'

jobs:
  build-windows-installer:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Get version from tag
        id: version
        shell: bash
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Install Inno Setup
        shell: pwsh
        run: |
          choco install innosetup -y --no-progress
          echo "C:\Program Files (x86)\Inno Setup 6" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Restore dependencies
        run: dotnet restore ${{ env.PROJECT_PATH }}

      - name: Publish application for installer
        shell: pwsh
        run: |
          dotnet publish ${{ env.PROJECT_PATH }} `
            -c Release `
            -r win-x64 `
            --self-contained true `
            -p:PublishSingleFile=false `
            -p:DebugType=none `
            -p:DebugSymbols=false `
            -p:Version=${{ steps.version.outputs.VERSION }}

      - name: Update installer version
        shell: pwsh
        run: |
          $issPath = "installer/windows/AITextVoice.iss"
          $content = Get-Content $issPath -Raw
          $content = $content -replace '#define MyAppVersion ".*"', '#define MyAppVersion "${{ steps.version.outputs.VERSION }}"'
          Set-Content $issPath $content

      - name: Build installer
        shell: pwsh
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer/windows/AITextVoice.iss

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: AITextVoice-Windows-Installer
          path: installer/windows/output/AITextVoice-Setup-*.exe
          retention-days: 1

  build-macos-dmg:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Get version from tag
        id: version
        shell: bash
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Import Code Signing Certificate
        env:
          APPLE_CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          # Create keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Import certificate
          echo "$APPLE_CERTIFICATE_BASE64" | base64 --decode > $RUNNER_TEMP/certificate.p12
          security import $RUNNER_TEMP/certificate.p12 -P "$APPLE_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

          # Clean up
          rm $RUNNER_TEMP/certificate.p12

      - name: Restore dependencies
        run: dotnet restore ${{ env.PROJECT_PATH }}

      - name: Create entitlements file
        run: |
          cat > entitlements.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>com.apple.security.cs.allow-jit</key>
              <true/>
              <key>com.apple.security.cs.allow-unsigned-executable-memory</key>
              <true/>
              <key>com.apple.security.cs.disable-library-validation</key>
              <true/>
              <key>com.apple.security.device.audio-input</key>
              <true/>
          </dict>
          </plist>
          EOF

      - name: Publish application
        run: |
          dotnet publish ${{ env.PROJECT_PATH }} \
            -c Release \
            -r osx-arm64 \
            --self-contained true \
            -p:PublishSingleFile=false \
            -p:DebugType=none \
            -p:DebugSymbols=false \
            -p:Version=${{ steps.version.outputs.VERSION }} \
            -o ./publish/AITextVoice.app/Contents/MacOS

          # Remove any pdb files that might have been created
          find ./publish -name "*.pdb" -delete

      - name: Build Swift Speech Helper
        run: |
          # Compile the Swift helper for arm64
          swiftc -O -target arm64-apple-macos10.15 \
            -o ./publish/AITextVoice.app/Contents/MacOS/MacOSSpeechHelper \
            src/MacOSSpeechHelper/main.swift

          # Make it executable
          chmod +x ./publish/AITextVoice.app/Contents/MacOS/MacOSSpeechHelper

      - name: Build Swift Audio Helper
        run: |
          # Compile the audio capture helper for arm64
          swiftc -O -target arm64-apple-macos11.0 \
            -o ./publish/AITextVoice.app/Contents/MacOS/MacOSAudioHelper \
            -framework AVFoundation \
            -framework Foundation \
            src/MacOSAudioHelper/main.swift

          # Make it executable
          chmod +x ./publish/AITextVoice.app/Contents/MacOS/MacOSAudioHelper

      - name: Create app icon (icns)
        run: |
          # Create iconset directory
          mkdir -p AppIcon.iconset

          # Use the 256px icon as source and create required sizes
          sips -z 16 16     src/AITextVoice.Avalonia/Resources/Icons/app_icon_256.png --out AppIcon.iconset/icon_16x16.png
          sips -z 32 32     src/AITextVoice.Avalonia/Resources/Icons/app_icon_256.png --out AppIcon.iconset/icon_16x16@2x.png
          sips -z 32 32     src/AITextVoice.Avalonia/Resources/Icons/app_icon_256.png --out AppIcon.iconset/icon_32x32.png
          sips -z 64 64     src/AITextVoice.Avalonia/Resources/Icons/app_icon_256.png --out AppIcon.iconset/icon_32x32@2x.png
          sips -z 128 128   src/AITextVoice.Avalonia/Resources/Icons/app_icon_256.png --out AppIcon.iconset/icon_128x128.png
          sips -z 256 256   src/AITextVoice.Avalonia/Resources/Icons/app_icon_256.png --out AppIcon.iconset/icon_128x128@2x.png
          sips -z 256 256   src/AITextVoice.Avalonia/Resources/Icons/app_icon_256.png --out AppIcon.iconset/icon_256x256.png
          sips -z 512 512   src/AITextVoice.Avalonia/Resources/Icons/app_icon_256.png --out AppIcon.iconset/icon_256x256@2x.png
          sips -z 512 512   src/AITextVoice.Avalonia/Resources/Icons/app_icon_256.png --out AppIcon.iconset/icon_512x512.png
          sips -z 512 512   src/AITextVoice.Avalonia/Resources/Icons/app_icon_256.png --out AppIcon.iconset/icon_512x512@2x.png

          # Convert to icns
          iconutil -c icns AppIcon.iconset -o AppIcon.icns

      - name: Create app bundle structure
        run: |
          mkdir -p ./publish/AITextVoice.app/Contents/Resources

          # Copy app icon
          cp AppIcon.icns ./publish/AITextVoice.app/Contents/Resources/AppIcon.icns

          # Create Info.plist
          cat > ./publish/AITextVoice.app/Contents/Info.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleName</key>
              <string>AITextVoice</string>
              <key>CFBundleDisplayName</key>
              <string>AITextVoice</string>
              <key>CFBundleIdentifier</key>
              <string>com.aitextvoice.app</string>
              <key>CFBundleVersion</key>
              <string>${{ steps.version.outputs.VERSION }}</string>
              <key>CFBundleShortVersionString</key>
              <string>${{ steps.version.outputs.VERSION }}</string>
              <key>CFBundleExecutable</key>
              <string>AITextVoice</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>CFBundleIconFile</key>
              <string>AppIcon</string>
              <key>LSMinimumSystemVersion</key>
              <string>10.15</string>
              <key>NSHighResolutionCapable</key>
              <true/>
              <key>NSMicrophoneUsageDescription</key>
              <string>AITextVoice needs microphone access for speech recognition.</string>
              <key>NSSpeechRecognitionUsageDescription</key>
              <string>AITextVoice needs speech recognition access for native macOS transcription.</string>
          </dict>
          </plist>
          EOF

          # Make executable
          chmod +x ./publish/AITextVoice.app/Contents/MacOS/AITextVoice

      - name: Code Sign Application
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          # Find the Developer ID Application certificate
          SIGNING_IDENTITY=$(security find-identity -v -p codesigning | grep "Developer ID Application" | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "Using signing identity: $SIGNING_IDENTITY"

          # Sign the app bundle with --deep to sign all nested Mach-O binaries
          # The --deep flag will sign dylibs and the main executable automatically
          codesign --force --deep --options runtime --entitlements entitlements.plist --sign "$SIGNING_IDENTITY" --timestamp ./publish/AITextVoice.app

          # Verify signature (without --strict as .NET DLLs aren't Mach-O binaries)
          codesign --verify --deep --verbose=2 ./publish/AITextVoice.app
          echo "Code signing completed successfully"

      - name: Create DMG
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          # Find signing identity for DMG
          SIGNING_IDENTITY=$(security find-identity -v -p codesigning | grep "Developer ID Application" | head -1 | sed 's/.*"\(.*\)".*/\1/')

          create-dmg \
            --volname "AITextVoice" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "AITextVoice.app" 150 190 \
            --hide-extension "AITextVoice.app" \
            --app-drop-link 450 190 \
            --codesign "$SIGNING_IDENTITY" \
            "AITextVoice-macOS-arm64-${{ steps.version.outputs.VERSION }}.dmg" \
            "./publish/AITextVoice.app" || true

          # Fallback if create-dmg fails
          if [ ! -f "AITextVoice-macOS-arm64-${{ steps.version.outputs.VERSION }}.dmg" ]; then
            hdiutil create -volname "AITextVoice" -srcfolder ./publish/AITextVoice.app -ov -format UDZO "AITextVoice-macOS-arm64-${{ steps.version.outputs.VERSION }}.dmg"
            codesign --force --sign "$SIGNING_IDENTITY" --timestamp "AITextVoice-macOS-arm64-${{ steps.version.outputs.VERSION }}.dmg"
          fi

      - name: Notarize DMG
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          # Submit for notarization
          xcrun notarytool submit "AITextVoice-macOS-arm64-${{ steps.version.outputs.VERSION }}.dmg" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_ID_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait

          # Staple the notarization ticket
          xcrun stapler staple "AITextVoice-macOS-arm64-${{ steps.version.outputs.VERSION }}.dmg"

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: AITextVoice-macOS-arm64-DMG
          path: AITextVoice-macOS-arm64-${{ steps.version.outputs.VERSION }}.dmg
          retention-days: 1

  build-macos-intel-dmg:
    runs-on: macos-15-intel  # Intel-based runner

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Get version from tag
        id: version
        shell: bash
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Import Code Signing Certificate
        env:
          APPLE_CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          # Create keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Import certificate
          echo "$APPLE_CERTIFICATE_BASE64" | base64 --decode > $RUNNER_TEMP/certificate.p12
          security import $RUNNER_TEMP/certificate.p12 -P "$APPLE_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

          # Clean up
          rm $RUNNER_TEMP/certificate.p12

      - name: Restore dependencies
        run: dotnet restore ${{ env.PROJECT_PATH }}

      - name: Create entitlements file
        run: |
          cat > entitlements.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>com.apple.security.cs.allow-jit</key>
              <true/>
              <key>com.apple.security.cs.allow-unsigned-executable-memory</key>
              <true/>
              <key>com.apple.security.cs.disable-library-validation</key>
              <true/>
              <key>com.apple.security.device.audio-input</key>
              <true/>
          </dict>
          </plist>
          EOF

      - name: Publish application
        run: |
          dotnet publish ${{ env.PROJECT_PATH }} \
            -c Release \
            -r osx-x64 \
            --self-contained true \
            -p:PublishSingleFile=false \
            -p:DebugType=none \
            -p:DebugSymbols=false \
            -p:Version=${{ steps.version.outputs.VERSION }} \
            -o ./publish/AITextVoice.app/Contents/MacOS

          # Remove any pdb files that might have been created
          find ./publish -name "*.pdb" -delete

      - name: Build Swift Speech Helper
        run: |
          # Compile the Swift helper for x64
          swiftc -O -target x86_64-apple-macos10.15 \
            -o ./publish/AITextVoice.app/Contents/MacOS/MacOSSpeechHelper \
            src/MacOSSpeechHelper/main.swift

          # Make it executable
          chmod +x ./publish/AITextVoice.app/Contents/MacOS/MacOSSpeechHelper

      - name: Build Swift Audio Helper
        run: |
          # Compile the audio capture helper for x64
          swiftc -O -target x86_64-apple-macos11.0 \
            -o ./publish/AITextVoice.app/Contents/MacOS/MacOSAudioHelper \
            -framework AVFoundation \
            -framework Foundation \
            src/MacOSAudioHelper/main.swift

          # Make it executable
          chmod +x ./publish/AITextVoice.app/Contents/MacOS/MacOSAudioHelper

      - name: Create app icon (icns)
        run: |
          # Create iconset directory
          mkdir -p AppIcon.iconset

          # Use the 256px icon as source and create required sizes
          sips -z 16 16     src/AITextVoice.Avalonia/Resources/Icons/app_icon_256.png --out AppIcon.iconset/icon_16x16.png
          sips -z 32 32     src/AITextVoice.Avalonia/Resources/Icons/app_icon_256.png --out AppIcon.iconset/icon_16x16@2x.png
          sips -z 32 32     src/AITextVoice.Avalonia/Resources/Icons/app_icon_256.png --out AppIcon.iconset/icon_32x32.png
          sips -z 64 64     src/AITextVoice.Avalonia/Resources/Icons/app_icon_256.png --out AppIcon.iconset/icon_32x32@2x.png
          sips -z 128 128   src/AITextVoice.Avalonia/Resources/Icons/app_icon_256.png --out AppIcon.iconset/icon_128x128.png
          sips -z 256 256   src/AITextVoice.Avalonia/Resources/Icons/app_icon_256.png --out AppIcon.iconset/icon_128x128@2x.png
          sips -z 256 256   src/AITextVoice.Avalonia/Resources/Icons/app_icon_256.png --out AppIcon.iconset/icon_256x256.png
          sips -z 512 512   src/AITextVoice.Avalonia/Resources/Icons/app_icon_256.png --out AppIcon.iconset/icon_256x256@2x.png
          sips -z 512 512   src/AITextVoice.Avalonia/Resources/Icons/app_icon_256.png --out AppIcon.iconset/icon_512x512.png
          sips -z 512 512   src/AITextVoice.Avalonia/Resources/Icons/app_icon_256.png --out AppIcon.iconset/icon_512x512@2x.png

          # Convert to icns
          iconutil -c icns AppIcon.iconset -o AppIcon.icns

      - name: Create app bundle structure
        run: |
          mkdir -p ./publish/AITextVoice.app/Contents/Resources

          # Copy app icon
          cp AppIcon.icns ./publish/AITextVoice.app/Contents/Resources/AppIcon.icns

          # Create Info.plist
          cat > ./publish/AITextVoice.app/Contents/Info.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleName</key>
              <string>AITextVoice</string>
              <key>CFBundleDisplayName</key>
              <string>AITextVoice</string>
              <key>CFBundleIdentifier</key>
              <string>com.aitextvoice.app</string>
              <key>CFBundleVersion</key>
              <string>${{ steps.version.outputs.VERSION }}</string>
              <key>CFBundleShortVersionString</key>
              <string>${{ steps.version.outputs.VERSION }}</string>
              <key>CFBundleExecutable</key>
              <string>AITextVoice</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>CFBundleIconFile</key>
              <string>AppIcon</string>
              <key>LSMinimumSystemVersion</key>
              <string>10.15</string>
              <key>NSHighResolutionCapable</key>
              <true/>
              <key>NSMicrophoneUsageDescription</key>
              <string>AITextVoice needs microphone access for speech recognition.</string>
              <key>NSSpeechRecognitionUsageDescription</key>
              <string>AITextVoice needs speech recognition access for native macOS transcription.</string>
          </dict>
          </plist>
          EOF

          # Make executable
          chmod +x ./publish/AITextVoice.app/Contents/MacOS/AITextVoice

      - name: Code Sign Application
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          # Find the Developer ID Application certificate
          SIGNING_IDENTITY=$(security find-identity -v -p codesigning | grep "Developer ID Application" | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "Using signing identity: $SIGNING_IDENTITY"

          # Sign the app bundle with --deep to sign all nested Mach-O binaries
          # The --deep flag will sign dylibs and the main executable automatically
          codesign --force --deep --options runtime --entitlements entitlements.plist --sign "$SIGNING_IDENTITY" --timestamp ./publish/AITextVoice.app

          # Verify signature (without --strict as .NET DLLs aren't Mach-O binaries)
          codesign --verify --deep --verbose=2 ./publish/AITextVoice.app
          echo "Code signing completed successfully"

      - name: Create DMG
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          # Find signing identity for DMG
          SIGNING_IDENTITY=$(security find-identity -v -p codesigning | grep "Developer ID Application" | head -1 | sed 's/.*"\(.*\)".*/\1/')

          create-dmg \
            --volname "AITextVoice" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "AITextVoice.app" 150 190 \
            --hide-extension "AITextVoice.app" \
            --app-drop-link 450 190 \
            --codesign "$SIGNING_IDENTITY" \
            "AITextVoice-macOS-x64-${{ steps.version.outputs.VERSION }}.dmg" \
            "./publish/AITextVoice.app" || true

          # Fallback if create-dmg fails
          if [ ! -f "AITextVoice-macOS-x64-${{ steps.version.outputs.VERSION }}.dmg" ]; then
            hdiutil create -volname "AITextVoice" -srcfolder ./publish/AITextVoice.app -ov -format UDZO "AITextVoice-macOS-x64-${{ steps.version.outputs.VERSION }}.dmg"
            codesign --force --sign "$SIGNING_IDENTITY" --timestamp "AITextVoice-macOS-x64-${{ steps.version.outputs.VERSION }}.dmg"
          fi

      - name: Notarize DMG
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          # Submit for notarization
          xcrun notarytool submit "AITextVoice-macOS-x64-${{ steps.version.outputs.VERSION }}.dmg" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_ID_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait

          # Staple the notarization ticket
          xcrun stapler staple "AITextVoice-macOS-x64-${{ steps.version.outputs.VERSION }}.dmg"

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: AITextVoice-macOS-x64-DMG
          path: AITextVoice-macOS-x64-${{ steps.version.outputs.VERSION }}.dmg
          retention-days: 1

  build-linux-appimage:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Get version from tag
        id: version
        shell: bash
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libfuse2

      - name: Download appimagetool
        run: |
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage -O appimagetool
          chmod +x appimagetool

      - name: Restore dependencies
        run: dotnet restore ${{ env.PROJECT_PATH }}

      - name: Publish application
        run: |
          dotnet publish ${{ env.PROJECT_PATH }} \
            -c Release \
            -r linux-x64 \
            --self-contained true \
            -p:PublishSingleFile=false \
            -p:DebugType=none \
            -p:DebugSymbols=false \
            -p:Version=${{ steps.version.outputs.VERSION }} \
            -o ./AppDir/usr/bin

      - name: Create AppDir structure
        run: |
          mkdir -p ./AppDir/usr/share/applications
          mkdir -p ./AppDir/usr/share/icons/hicolor/256x256/apps

          # Copy desktop file
          cp installer/linux/AITextVoice.desktop ./AppDir/usr/share/applications/
          cp installer/linux/AITextVoice.desktop ./AppDir/

          # Copy icon (convert ico to png if needed, or use existing png)
          if [ -f "src/AITextVoice.Avalonia/Resources/Icons/app_icon_256.png" ]; then
            cp src/AITextVoice.Avalonia/Resources/Icons/app_icon_256.png ./AppDir/usr/share/icons/hicolor/256x256/apps/aitextvoice.png
            cp src/AITextVoice.Avalonia/Resources/Icons/app_icon_256.png ./AppDir/aitextvoice.png
          fi

          # Create AppRun script
          cat > ./AppDir/AppRun << 'EOF'
          #!/bin/bash
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          export PATH="${HERE}/usr/bin:${PATH}"
          export LD_LIBRARY_PATH="${HERE}/usr/lib:${LD_LIBRARY_PATH}"
          exec "${HERE}/usr/bin/AITextVoice" "$@"
          EOF
          chmod +x ./AppDir/AppRun

      - name: Build AppImage
        run: |
          ARCH=x86_64 ./appimagetool ./AppDir AITextVoice-Linux-x64-${{ steps.version.outputs.VERSION }}.AppImage

      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: AITextVoice-Linux-AppImage
          path: AITextVoice-Linux-x64-${{ steps.version.outputs.VERSION }}.AppImage
          retention-days: 1

  release:
    needs: [build-windows-installer, build-macos-dmg, build-macos-intel-dmg, build-linux-appimage]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: List artifacts
        run: find ./artifacts -type f

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: AITextVoice v${{ steps.version.outputs.VERSION }}
          draft: false
          prerelease: ${{ contains(github.ref, '-beta') || contains(github.ref, '-alpha') || contains(github.ref, '-rc') }}
          generate_release_notes: true
          files: |
            ./artifacts/**/*.exe
            ./artifacts/**/*.dmg
            ./artifacts/**/*.AppImage
          body: |
            ## AITextVoice v${{ steps.version.outputs.VERSION }}

            AI-powered speech-to-text and text-to-speech application with local processing using Whisper and Piper.

            ### Downloads

            | Platform | Architecture | Download |
            |----------|--------------|----------|
            | **Windows** | x64 | `AITextVoice-Setup-${{ steps.version.outputs.VERSION }}.exe` |
            | **macOS** | Apple Silicon (M1/M2/M3) | `AITextVoice-macOS-arm64-${{ steps.version.outputs.VERSION }}.dmg` |
            | **macOS** | Intel | `AITextVoice-macOS-x64-${{ steps.version.outputs.VERSION }}.dmg` |
            | **Linux** | x64 | `AITextVoice-Linux-x64-${{ steps.version.outputs.VERSION }}.AppImage` |

            ### Installation

            #### Windows
            Download and run `AITextVoice-Setup-${{ steps.version.outputs.VERSION }}.exe` for a full installation with Start Menu shortcuts and uninstaller.

            #### macOS
            1. Download the `.dmg` file for your Mac (Apple Silicon or Intel)
            2. Open the DMG and drag AITextVoice to Applications
            3. On first launch, grant Accessibility and Microphone permissions

            #### Linux
            1. Download the `.AppImage` file
            2. Make it executable: `chmod +x AITextVoice-*.AppImage`
            3. Run it: `./AITextVoice-*.AppImage`

            ### Notes

            - **macOS**: Requires Accessibility permission (System Preferences > Security & Privacy > Privacy > Accessibility)
            - **Linux**: Requires X11 desktop environment. AppImage needs FUSE to run.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
